<!-- Timeline Lib http://almende.github.io/chap-links-library/timeline.html -->
<!-- Timeline example http://almende.github.io/chap-links-library/js/timeline/examples/example17_json_data.html -->
<polymer-element name="widget-timeline" attributes="options">
  <template>
    <link rel="stylesheet" type="text/css" href="vendor/timeline-2.6.1/timeline.css">
    <link rel="stylesheet" type="text/css" href="vendor/timeline-2.6.1/timeline-theme.css">
    <ab-widget name="Timeline">
      <div class="edit">
        <table>
          <thead>
            <tr>
              <th>Start</th>
              <th>Content</th>
              <th>End <i>(optional)</i></th>
            </tr>
          </thead>
          <tbody>
            <template repeat="{{e in events}}">
              <tr>
                <td><input type="date" value="{{e._start}}" /></td>
                <td><textarea value="{{e.content}}"></textarea></td>
                <td><input type="date" value="{{e._end}}" min="{{e._start}}" disabled?="{{!e._start}}" /></td>
              </tr>
            </template>
          </tbody>
        </table>
        <button on-click="{{addEvent}}">Add event</button>
      </div>
      <div class="view">
        <div id="timeline"></div>
      </div>
    </ab-widget>
  </template>
  <script type="text/javascript" src="vendor/timeline-2.6.1/timeline.js"></script>
  <script type="text/javascript" src="vendor/timeline-2.6.1/timeline-locales.js"></script>
  <script>
    Polymer('widget-timeline', {

      ready: function() {
        this.events = [];
        this.timelineOpts = {
          height: '300px',
          width: '100%',
          style: 'box',
          locale: 'fr'
        };
        this.timeline = new links.Timeline(this.$.timeline);
        this.redraw();
        this.addEventListener('showView', this.redraw.bind(this));
      },

      redraw: function() {
        this.async(function() {
          this.rebuildDates();
          this.timeline.draw(this.events, this.timelineOpts);
          this.timeline.setVisibleChartRangeAuto();
        });
      },

      rebuildDates: function() {
        this.events.forEach(function(e) {
          e.start = e._start ? new Date(e._start.replace(/-/g, "/")) : null;
          e.end = e._end ? new Date(e._end.replace(/-/g, "/")) : null;
        });
      },

      addEvent: function() {
        this.events.push({
          _start: null,
          _end: null,
          content: ''
        });
      },

      exports: function() {
        return {
          events: this.events,
          timelineOpts: this.timelineOpts
        };
      }

    });
  </script>
</polymer-element>